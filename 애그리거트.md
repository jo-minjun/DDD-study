# 3. 애그리거트

## 1. 애그리거트

![23.png](./img//23.png)

- 온라인 쇼핑몰 시스템을 개발할 때 위 그림과 같이 상위 수준 개념을 이용해서 전체 모델을 정리하면 전반적인 관계를 이해하는 데 도움이 된다.
- 그림의 상위 수준 모델을 개별 객체 단위로 다시 그려보면 아래 그림과 같다.
  ![24.png](./img/24.png)
  - 상위 수준 모델에 대한 이해 없이 위 그림을 그리려면 더 오랜 시간이 걸린다.
- 도메인 객체 모델이 복잡해지면 개별 구성요소 위주로 모델을 이해하게 되고 전반적인 구조나 큰 수준에서 도메인 간의 관계를 파악하기 어려워진다.
- 주요 도메인 요소 간의 관계를 파악하기 어렵다는 것은 코드를 변경하고 확장하는 것이 어려워진다는 것을 의미한다.
- 애그리거트는 아래와 같은 장점이 있다.
  - 수많은 객체를 애그리거트로 묶어서 바라보면 상위 수준에서 도메인 모델 간의 관계를 파악할 수 있다.
    - 아래 그림은 위 그림을 애그리거트 단위로 묶어서 다시 표현한 것이다.
      ![25.png](./img/25.png)
    - 동일한 모델이지만 애그리거트를 사용함으로써 모델 간의 관계를 개별 모델 수준과 상위 수준에서 모두 이해할 수 있다.
  - 애그리거트는 일관성을 관리하는 기준이 된다.
    - 애그리거트 단위로 일관성을 관리하기 때문에 복잡한 모델을 단순하게 만들어준다. 복잡도가 낮아지는 만큼 도메인 기능을 확장하고 변경하는 데 필요한 노력과 시간도 줄어든다.
    - 애그리거트는 관련된 모델을 하나로 모았기 때문에 한 애그리거트에 속한 객체는 유사하거나 동일한 라이프 사이클을 갖는다.
    - 주문 애그리거트를 만들려면 Order, OrderLine, Orderer와 같은 관련 객체를 함께 생성해야 한다.
      - Order는 생성했는데 ShippingInfo는 만들지 않거나 ShippingInfo를 생성하면서 Orderer를 생성하지 않는 경우는 없다.
- 애그리거트는 독립된 객체 군이며 각 애그리거트는 자기 자신을 관리할 뿐 다른 애그리거트를 관리하지 않는다.
  - 주문 애그리거트는 회원의 비밀번호나 상품의 가격을 변경하지 않는다.
- 경계를 생성할 때 기본이 되는 것은 도메인 규칙과 요구사항이다. 도메인 규칙에 따라 함께 생성되는 구성요소는 한 애그리거트에 속할 가능성이 높다.
  - 주문할 상품 개수, 배송지 정보 주문자 정보는 주문 시점에 함께 생성되므로 이들은 한 애그리거트에 속한다.
  - OrderLine의 주문 상품 개수를 변경하면 도메인 규칙에 따라 Order의 총 주문 금액을 새로 계산해야 한다.
- 흔히 ‘A가 B를 갖는다.’로 설계할 수 있는 요구사항이 있다고 해서 반드시 A와 B가 한 애그리거트에 속한다는 것을 의미하는 것은 아니다.
  - 상품 상세 정보와 함께 리뷰 내용을 보여줘야 한다는 요구사항이 있을 때Product 엔티티와 Review 엔티티가 한 애그리거트에 속한다고 생각할 수 있다.
  - 하지만 Product와 Review는 함께 생성되지 않고, 함께 변경되지도 않는다. 개다가 엔티티를 변경하는 주체가 상품 담당자와 고객으로 서로 다르다.
    ![26.png](./img/26.png)
- 처음 도메인 모델을 만들기 시작하면 큰 애그리거트로 보이는 것들이 많지만, 도메인에 대한 경험이 생기고 도메인 규칙을 이해할수록 애그리거트의 실제 크기는 줄어든다.

## 2. 애그리거트 루트

## 3. 리포지터리와 애그리거트

## 4. ID를 이용한 애그리거트 참조

## 5. 애그리거트 간 집합 연관

## 6. 애그리거트를 팩토리로 사용하기
